# ç¬¬1.3èŠ‚å­¦ä¹ æ€»ç»“ - æ„å»ºç³»ç»Ÿå®è·µå®Œæˆ

## âœ… å·²å®Œæˆçš„å†…å®¹

### 1. å®‰è£… esbuild
- âœ… åœ¨æ ¹ç›®å½•å®‰è£… `esbuild@0.25.0`
- âœ… ç†è§£äº†ä¸ºä»€ä¹ˆè¦å®‰è£…åœ¨æ ¹ç›®å½•ï¼ˆå…¨å±€æ„å»ºå·¥å…·ï¼‰

### 2. åˆ›å»ºé…ç½®æ–‡ä»¶
- âœ… åˆ›å»ºäº† `esbuild.config.mjs` - esbuild æ‰“åŒ…é…ç½®
- âœ… åˆ›å»ºäº† `scripts/build.mjs` - å®Œæ•´æ„å»ºè„šæœ¬

### 3. æ·»åŠ æ„å»ºå‘½ä»¤
- âœ… ä¿®æ”¹ `package.json` æ·»åŠ npm scriptsï¼š
  - `npm run build` - åªç¼–è¯‘packages (tsc)
  - `npm run bundle` - åªæ‰“åŒ…CLI (esbuild)
 - `npm run build:all` - å®Œæ•´æ„å»ºæµç¨‹

### 4. æµ‹è¯•æ„å»º
- âœ… æˆåŠŸæ‰“åŒ…å‡º `bundle/my-cli.mjs`
- âœ… éªŒè¯æ‰“åŒ…åçš„CLIèƒ½æ­£å¸¸è¿è¡Œ

---

## ğŸ“‚ é¡¹ç›®ç»“æ„å˜åŒ–

**ä¹‹å‰**:
```
ai-cli-project/
  â”œâ”€ packages/
  â”‚   â”œâ”€ core/dist/  (tscç¼–è¯‘çš„å¤šä¸ªæ–‡ä»¶)
  â”‚   â””â”€ cli/dist/   (tscç¼–è¯‘çš„å¤šä¸ªæ–‡ä»¶)
  â””â”€ package.json
```

**ç°åœ¨**:
```
ai-cli-project/
  â”œâ”€ packages/
  â”‚   â”œâ”€ core/dist/       (tscç¼–è¯‘)
  â”‚   â””â”€ cli/dist/        (tscç¼–è¯‘)
  â”œâ”€ bundle/
  â”‚   â””â”€ my-cli].mjs      âœ¨ esbuildæ‰“åŒ…çš„å•æ–‡ä»¶
  â”œâ”€ scripts/
  â”‚   â””â”€ build.mjs        ğŸ”§ æ„å»ºè„šæœ¬
  â”œâ”€ esbuild.config.mjs   âš™ï¸ esbuildé…ç½®
  â””â”€ package.json
```

---

## ğŸ”‘ æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨ .mjs æ‰©å±•åï¼Ÿ

**é—®é¢˜**: Node.js é»˜è®¤æŠŠ `.js` æ–‡ä»¶å½“ä½œ CommonJS æ¨¡å—

**è§£å†³æ–¹æ¡ˆ**:
- æ–¹æ¡ˆ1: åœ¨ package.json æ·»åŠ  `"type": "module"`
- æ–¹æ¡ˆ2: ä½¿ç”¨ `.mjs` æ‰©å±•åâœ… (æˆ‘ä»¬çš„é€‰æ‹©)

**åŸå› **: `.mjs` æ˜ç¡®å‘Šè¯‰ Node.js è¿™æ˜¯ ES Moduleï¼Œä¸å— package.json å½±å“

**åç«¯ç±»æ¯”**: å°±åƒ Java ä¸­ `.java` vs `.class` æ–‡ä»¶ï¼Œæ‰©å±•åå†³å®šäº†æ–‡ä»¶çš„å¤„ç†æ–¹å¼

### 2. tsc ç¼–è¯‘ vs esbuild æ‰“åŒ…

| æ–¹é¢ | tsc ç¼–è¯‘ | esbuild æ‰“åŒ… |
|------|---------|--------------|
| **è¾“å‡º** | å¤šä¸ªæ–‡ä»¶ | å•ä¸ªæ–‡ä»¶ |
| **ç±»å‹å®šä¹‰** | ç”Ÿæˆ .d.ts | ä¸ç”Ÿæˆ |
| **é€Ÿåº¦** | æ…¢ | æå¿« |
| **ç”¨é€”** | å‘å¸ƒnpmåº“ | å‘å¸ƒå¯æ‰§è¡Œç¨‹åº |
| **åç«¯ç±»æ¯”** | ç¼–è¯‘.classæ–‡ä»¶ | æ‰“åŒ…fat JAR |

### 3. æ„å»ºæµç¨‹

```
npm run build:all
  â”‚
  â”œâ”€ Step 1: æ£€æŸ¥ä¾èµ– (npm install)
  â”œâ”€ Step 2: ç¼–è¯‘packages (tsc)
  â”‚    â”œâ”€ packages/core â†’ dist/
  â”‚    â””â”€ packages/cli â†’ dist/
  â””â”€ Step 3: æ‰“åŒ…CLI (esbuild)
       â””â”€ æ‰€æœ‰ä»£ç  â†’ bundle/my-cli.mjs
```

**åç«¯ç±»æ¯”**:
- Step 1-2 = `mvn compile`
- Step 3 = `mvn assembly:single`

---

## ğŸ’¡ é‡è¦é…ç½®è¯´æ˜

### esbuild.config.mjs å…³é”®é…ç½®

```javascript
{
  bundle: true,              // æ‰“åŒ…æ‰€æœ‰ä¾èµ–åˆ°ä¸€ä¸ªæ–‡ä»¶
  platform: 'node',          // ç›®æ ‡æ˜¯Node.jsç¯å¢ƒ
  format: 'esm',             // è¾“å‡ºES Moduleæ ¼å¼
  entryPoints: ['...'],      // å…¥å£æ–‡ä»¶
  outfile: 'bundle/my-cli.mjs',  // è¾“å‡ºæ–‡ä»¶
  banner: { js: '...' },     // æ–‡ä»¶å¼€å¤´æ³¨å…¥çš„ä»£ç 
  define: { '...': '...' },  // ç¼–è¯‘æ—¶å¸¸é‡æ›¿æ¢
  external: [],              // ä¸æ‰“åŒ…çš„ä¾èµ–
}
```

#### banner çš„ä½œç”¨

**é—®é¢˜**: ES Module æ²¡æœ‰ `require`ã€`__filename`ã€`__dirname`

**è§£å†³**: åœ¨æ‰“åŒ…æ–‡ä»¶å¼€å¤´æ³¨å…¥ä»£ç åˆ›å»ºè¿™äº›å˜é‡

**åç«¯ç±»æ¯”**: ç±»ä¼¼äº Spring Boot çš„è‡ªåŠ¨é…ç½®ï¼Œåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å…¥ä¾èµ–

#### define çš„ä½œç”¨

**ç¼–è¯‘å‰**:
```javascript
console.log(process.env.CLI_VERSION);
```

**ç¼–è¯‘å**:
```javascript
console.log("1.0.0");  // ç›´æ¥æ›¿æ¢æˆå¸¸é‡
```

**åç«¯ç±»æ¯”**: ç±»ä¼¼ Maven çš„ resource filteringï¼Œç¼–è¯‘æ—¶æ›¿æ¢å ä½ç¬¦

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ–‡ä»¶å¤§å°

```bash
# packages/cli/dist (tscç¼–è¯‘)
index.js:     çº¦ 1KB  
index.d.ts:   çº¦ 0.5KB
æ€»è®¡: å¤šä¸ªæ–‡ä»¶

# bundle/my-cli.mjs (esbuildæ‰“åŒ…)
my-cli.mjs:   çº¦ 1.4KB
æ€»è®¡: å•ä¸ªæ–‡ä»¶
```

### å¯åŠ¨é€Ÿåº¦

- **tscç¼–è¯‘ç‰ˆæœ¬**: éœ€è¦åŠ è½½å¤šä¸ªæ–‡ä»¶ï¼Œç›¸å¯¹è¾ƒæ…¢
- **esbuildæ‰“åŒ…ç‰ˆæœ¬**: å•æ–‡ä»¶åŠ è½½ï¼Œæ›´å¿« âœ¨

---

## ğŸ“ å­¦åˆ°çš„æœ€ä½³å®è·µ

### 1. Monorepo ä¾èµ–ç®¡ç†

| ä¾èµ–ç±»å‹ | å®‰è£…ä½ç½® | ç¤ºä¾‹ |
|---------|----------|------|
| å…¨å±€æ„å»ºå·¥å…· | æ ¹ç›®å½• devDependencies | esbuild, vitest, eslint |
| åŒ…ç‰¹å®šè¿è¡Œæ—¶ä¾èµ– | package devDependencies/dependencies | ink, yargs, @google/genai |

### 2. æ–‡ä»¶æ‰©å±•åç­–ç•¥

| æ–‡ä»¶ | ä½¿ç”¨æ‰©å±•å | åŸå›  |
|------|-----------|------|
| æºç  | `.ts` | TypeScriptæºæ–‡ä»¶ |
| é…ç½®/è„šæœ¬ | `.mjs` | ES Moduleè„šæœ¬ |
| æ‰“åŒ…è¾“å‡º | `.mjs` | ES Moduleå¯æ‰§è¡Œæ–‡ä»¶ |

### 3. æ„å»ºå‘½ä»¤è®¾è®¡

```json
{
  "build": "ç¼–è¯‘å„ä¸ªåŒ…",       // å¼€å‘æ—¶é¢‘ç¹ä½¿ç”¨
  "bundle": "æ‰“åŒ…æœ€ç»ˆåº”ç”¨",    // å‘å¸ƒå‰ä½¿ç”¨
  "build:all": "å®Œæ•´æ„å»ºæµç¨‹"  // CI/CDä½¿ç”¨
}
```

**åç«¯ç±»æ¯”**:
- `build` = `mvn compile`
- `bundle` =` mvn package`
- `build:all` = `mvn clean install`

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æŒæ¡äº†ï¼š
- âœ… Monorepo æ¶æ„ (1.1)
- âœ… TypeScript é…ç½® (1.2)
- âœ… æ„å»ºç³»ç»Ÿ (1.3)

**å·²å®Œæˆç¬¬ä¸€é˜¶æ®µï¼**

ä¸‹ä¸€æ­¥å¯ä»¥å¼€å§‹å­¦ä¹ ï¼š
- ğŸ“– ç¬¬2.1èŠ‚: Ink æ¡†æ¶åŸºç¡€ (ç»ˆç«¯UIå¼€å‘)
- ğŸ“– ç¬¬2.2èŠ‚: æ ¸å¿ƒUIç»„ä»¶
- ğŸ“– ç¬¬2.3èŠ‚: å‘½ä»¤ç³»ç»Ÿ

---

## ğŸ“ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# å®Œæ•´æ„å»º
npm run build:all

# åªç¼–è¯‘packages
npm run build

# åªæ‰“åŒ…CLI
npm run bundle

# æµ‹è¯•æ‰“åŒ…åçš„CLI
node bundle/my-cli.mjs
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ banner æ³¨å…¥ä»£ç ï¼Ÿ

**A**: å› ä¸º ES Module æ²¡æœ‰ `require`ã€`__filename`ã€`__dirname`ï¼Œä½†å¾ˆå¤š Node.js ä»£ç ä¾èµ–è¿™äº›å˜é‡ã€‚banner åœ¨æ–‡ä»¶å¼€å¤´åˆ›å»ºè¿™äº›å˜é‡ä»¥ä¿è¯å…¼å®¹æ€§ã€‚

### Q2: external ä»€ä¹ˆæ—¶å€™éœ€è¦é…ç½®ï¼Ÿ

**A**: å½“ä½ ä½¿ç”¨åŒ…å«åŸç”Ÿæ¨¡å—ï¼ˆ.nodeæ–‡ä»¶ï¼‰çš„åŒ…æ—¶ï¼Œè¿™äº›åŒ…ä¸èƒ½æ‰“åŒ…è¿›å»ï¼Œå¿…é¡»åœ¨è¿è¡Œæ—¶ä» node_modules åŠ è½½ã€‚

### Q3: ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ `"type": "module"` ï¼Ÿ

**A**: è™½ç„¶å¯ä»¥ï¼Œä½†ä½¿ç”¨ `.mjs` æ›´æ˜ç¡®ï¼Œä¸å½±å“å…¶ä»–å¯èƒ½ä½¿ç”¨ CommonJS çš„ä»£ç ã€‚

---

## ğŸ¯ å­¦ä¹ æ£€æŸ¥æ¸…å•

- [x] ç†è§£ esbuild çš„ä½œç”¨å’Œä¼˜åŠ¿
- [x] ç†è§£ tsc å’Œ esbuild çš„åŒºåˆ«
- [x] æˆåŠŸå®‰è£…å’Œé…ç½® esbuild
- [x] ç†è§£ bundleã€externalã€bannerã€å®šä¹‰ç­‰é…ç½®
- [x] æˆåŠŸæ„å»ºå‡ºå•æ–‡ä»¶çš„ CLI åº”ç”¨
- [x] ç†è§£ .mjs æ‰©å±•åçš„ç”¨é€”
- [x] æŒæ¡ Monorepo ä¾èµ–ç®¡ç†ç­–ç•¥

**æ­å–œï¼ç¬¬1.3èŠ‚å­¦ä¹ å®Œæˆï¼** ğŸ‰
