# å­¦ä¹ ç¬”è®° - æ„å»ºç³»ç»Ÿ (esbuild)

## ğŸ“– å­¦ä¹ ç›®æ ‡

1. ç†è§£ esbuild çš„ä½œç”¨å’Œä¼˜åŠ¿
2. å­¦ä¹ å¦‚ä½•é…ç½® esbuild æ‰“åŒ… CLI å·¥å…·
3. ç†è§£å¦‚ä½•å¤„ç†èµ„æºæ–‡ä»¶å’Œå¤–éƒ¨ä¾èµ–
4. ç”Ÿæˆå¯æ‰§è¡Œçš„ CLI æ–‡ä»¶

---

## ğŸ” ä»€ä¹ˆæ˜¯ esbuildï¼Ÿ

### esbuild çš„ä½œç”¨

esbuild æ˜¯ä¸€ä¸ª**æé€Ÿ**çš„ JavaScript æ‰“åŒ…å·¥å…·ï¼Œä¸»è¦ç”¨äºï¼š

1. **æ‰“åŒ…ä»£ç **: å°†å¤šä¸ªæ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæˆ–å‡ ä¸ªæ–‡ä»¶
2. **ç¼–è¯‘ TypeScript**: å°† TS ä»£ç è½¬æ¢ä¸º JS
3. **å‹ç¼©ä»£ç **: å‡å°æ–‡ä»¶ä½“ç§¯
4. **å¤„ç†ä¾èµ–**: è§£æå’Œæ‰“åŒ… node_modules ä¸­çš„ä¾èµ–

### ä¸ºä»€ä¹ˆä½¿ç”¨ esbuildï¼Ÿ

- âš¡ **æå¿«**: æ¯”ä¼ ç»Ÿå·¥å…·(webpack, rollup)å¿« 10-100 å€
- ğŸ¯ **ç®€å•**: é…ç½®ç®€å•ç›´è§‚
- ğŸ“¦ **ä¸€ä½“åŒ–**: å†…ç½® TypeScript ç¼–è¯‘ï¼Œæ— éœ€é¢å¤–å·¥å…·

### TypeScript ç¼–è¯‘å™¨(tsc) vs esbuild

| ç‰¹æ€§ | tsc | esbuild |
|-----|-----|---------|
| ç±»å‹æ£€æŸ¥ | âœ… å®Œæ•´çš„ç±»å‹æ£€æŸ¥ | âŒ ä¸åšç±»å‹æ£€æŸ¥ |
| ç”Ÿæˆç±»å‹å£°æ˜(.d.ts) | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| ç¼–è¯‘é€Ÿåº¦ | ğŸ¢ è¾ƒæ…¢ | âš¡ æå¿« |
| æ‰“åŒ…èƒ½åŠ› | âŒ ä¸æ‰“åŒ… | âœ… å®Œæ•´æ‰“åŒ… |
| é€‚ç”¨åœºæ™¯ | åº“çš„å¼€å‘å’Œæ„å»º | CLIå·¥å…·ã€åº”ç”¨ç¨‹åºæ‰“åŒ… |

**ç»“è®º**: 
- å¯¹äº**åº“(core)**ï¼šä½¿ç”¨ `tsc` ç¼–è¯‘ï¼Œä¿ç•™ç±»å‹å®šä¹‰ï¼Œæ–¹ä¾¿å…¶ä»–é¡¹ç›®ä½¿ç”¨
- å¯¹äº**åº”ç”¨(CLI)**ï¼šå¯ä»¥ä½¿ç”¨ `esbuild` æ‰“åŒ…æˆå•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶

---

## ğŸ“‹ gemini-cli çš„æ„å»ºç­–ç•¥åˆ†æ

### æ„å»ºæµç¨‹

gemini-cli é‡‡ç”¨äº†æ··åˆæ„å»ºç­–ç•¥ï¼š

```
1. packages/* (åº“) â†’ ä½¿ç”¨ tsc ç¼–è¯‘
   â”œâ”€ ä¿ç•™å®Œæ•´çš„ç±»å‹å®šä¹‰ (.d.ts)
   â”œâ”€ ä¿ç•™æ¨¡å—ç»“æ„ (æ¯ä¸ªæ–‡ä»¶å•ç‹¬ç¼–è¯‘)
   â””â”€ è¾“å‡ºåˆ° dist/ ç›®å½•

2. æœ€ç»ˆ CLI åº”ç”¨ â†’ ä½¿ç”¨ esbuild æ‰“åŒ…
   â”œâ”€ å°†æ‰€æœ‰ä»£ç æ‰“åŒ…æˆå•ä¸ªæ–‡ä»¶
   â”œâ”€ ä¸éœ€è¦ç±»å‹å®šä¹‰(æœ€ç»ˆäº§ç‰©)
   â””â”€ è¾“å‡ºåˆ° bundle/ ç›®å½•
```

### å…³é”®æ–‡ä»¶è§£æ

#### 1. `esbuild.config.js` - esbuild é…ç½®

```javascript
// ä¸»è¦é…ç½®é¡¹
const baseConfig = {
  bundle: true,          // æ‰“åŒ…æ‰€æœ‰ä¾èµ–
  platform: 'node',      // ç›®æ ‡å¹³å°æ˜¯ Node.js
  format: 'esm',         // è¾“å‡º ES Module æ ¼å¼
  external: [...],       // ä¸æ‰“åŒ…çš„å¤–éƒ¨ä¾èµ–
  loader: { '.node': 'file' }  // å¤„ç† .node åŸç”Ÿæ¨¡å—
};

const cliConfig = {
  ...baseConfig,
  entryPoints: ['packages/cli/index.ts'],  // å…¥å£æ–‡ä»¶
  outfile: 'bundle/gemini.js',             // è¾“å‡ºæ–‡ä»¶
  banner: {                                 // æ·»åŠ å¤´éƒ¨ä»£ç 
    js: `import { createRequire } from 'module'; ...`
  },
  define: {                                 // å®šä¹‰ç¯å¢ƒå˜é‡
    'process.env.CLI_VERSION': JSON.stringify(pkg.version)
  },
  plugins: [...]                            // æ’ä»¶(å¤„ç† WASM ç­‰)
};
```

**é‡è¦æ¦‚å¿µè§£é‡Š**:

- **`bundle: true`**: å°†æ‰€æœ‰å¯¼å…¥çš„æ¨¡å—æ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­
- **`platform: 'node'`**: ç”Ÿæˆçš„ä»£ç è¿è¡Œåœ¨ Node.js ç¯å¢ƒ
- **`format: 'esm'`**: è¾“å‡º ES Module æ ¼å¼(`import/export`)
- **`external`**: æŸäº›åŒ…ä¸æ‰“åŒ…è¿›å»ï¼Œè¿è¡Œæ—¶ä» node_modules åŠ è½½
- **`banner`**: åœ¨ç”Ÿæˆçš„æ–‡ä»¶å¼€å¤´æ·»åŠ ä»£ç (ç”¨äºå…¼å®¹æ€§å¤„ç†)

#### 2. `scripts/build.js` - ä¸»æ„å»ºè„šæœ¬

```javascript
// 1. æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
if (!existsSync('node_modules')) {
  execSync('npm install');
}

// 2. ç”Ÿæˆä»£ç (å¦‚æœæœ‰ä»£ç ç”Ÿæˆæ­¥éª¤)
execSync('npm run generate');

// 3. æ„å»ºæ‰€æœ‰ workspaces
execSync('npm run build --workspaces');

// 4. æ„å»ºæ²™ç®±å®¹å™¨(å¯é€‰)
```

**æ‰§è¡Œæµç¨‹**:
1. é¦–å…ˆä½¿ç”¨ `tsc` ç¼–è¯‘å„ä¸ª package
2. ç„¶åä½¿ç”¨ `esbuild` æ‰“åŒ…æœ€ç»ˆçš„ CLI æ–‡ä»¶

#### 3. `scripts/build_package.js` - å•ä¸ªåŒ…çš„æ„å»ºè„šæœ¬

```javascript
// å¿…é¡»åœ¨ packages/* ç›®å½•ä¸‹æ‰§è¡Œ
if (!process.cwd().includes('packages')) {
  console.error('must be invoked from a package directory');
  process.exit(1);
}

// ä½¿ç”¨ TypeScript ç¼–è¯‘
execSync('tsc --build');

// å¤åˆ¶å…¶ä»–æ–‡ä»¶(.md, .json)
execSync('node ../../scripts/copy_files.js');

// æ ‡è®°æ„å»ºå®Œæˆ
writeFileSync('dist/.last_build', '');
```

---

## ğŸ—‚ï¸ Monorepo ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ

### ä¾èµ–åº”è¯¥å®‰è£…åœ¨å“ªé‡Œï¼Ÿ

#### âœ… æ ¹ç›®å½• (`package.json`)

**å…¨å±€å·¥å…·å’Œå¼€å‘ä¾èµ–** - ç”¨äºæ•´ä¸ªé¡¹ç›®çš„æ„å»ºã€æµ‹è¯•ã€è´¨é‡æ£€æŸ¥ï¼š

```json
{
  "devDependencies": {
    // æ„å»ºå·¥å…·
    "esbuild": "^0.25.0",              // æ‰“åŒ…æœ€ç»ˆåº”ç”¨
    "esbuild-plugin-wasm": "^1.1.0",   // esbuild æ’ä»¶
    
    // æµ‹è¯•å·¥å…·
    "vitest": "^3.2.4",                // æµ‹è¯•æ¡†æ¶
    
    // ä»£ç è´¨é‡å·¥å…·
    "eslint": "^9.24.0",               // ä»£ç æ£€æŸ¥
    "prettier": "^3.5.3",              // ä»£ç æ ¼å¼åŒ–
    
    // ç±»å‹å®šä¹‰ï¼ˆå¦‚æœæ‰€æœ‰ packages éƒ½éœ€è¦ï¼‰
    "@types/node": "^24.10.1",         // Node.js ç±»å‹
    
    // å®ç”¨å·¥å…·
    "tsx": "^4.20.3",                  // ç›´æ¥è¿è¡Œ TS æ–‡ä»¶
    "cross-env": "^7.0.3"              // è·¨å¹³å°ç¯å¢ƒå˜é‡
  }
}
```

**åˆ¤æ–­æ ‡å‡†**ï¼š
- â“ è¿™ä¸ªå·¥å…·æ˜¯å¦è¢«å¤šä¸ª packages ä½¿ç”¨ï¼Ÿ â†’ æ ¹ç›®å½•
- â“ è¿™ä¸ªå·¥å…·æ˜¯å¦ç”¨äºæ•´ä¸ªé¡¹ç›®çš„æ„å»ºæµç¨‹ï¼Ÿ â†’ æ ¹ç›®å½•  
- â“ è¿™æ˜¯å¼€å‘å’Œæ„å»ºå·¥å…·ï¼Œä¸æ˜¯è¿è¡Œæ—¶ä¾èµ–ï¼Ÿ â†’ æ ¹ç›®å½•

#### âœ… Package ç›®å½• (`packages/*/package.json`)

**ç‰¹å®š package çš„è¿è¡Œæ—¶ä¾èµ–**ï¼š

```json
// packages/core/package.json
{
  "dependencies": {
    "@google/genai": "^1.0.0",  // åªæœ‰ core ä½¿ç”¨ Gemini API
    "zod": "^3.22.0"             //  core éœ€è¦çš„ schema éªŒè¯
  },
  "devDependencies": {
    "typescript": "^5.0.0"       // æ¯ä¸ª package å¯èƒ½éœ€è¦ä¸åŒç‰ˆæœ¬çš„ TS
  }
}

// packages/cli/package.json
{
  "dependencies": {
    "@ai-cli-project/core": "*",  // ä¾èµ–åŒ monorepo çš„å…¶ä»– package
    "ink": "^6.0.0",               // åªæœ‰ CLI ä½¿ç”¨ Ink
    "yargs": "^17.7.2"             // CLI å‚æ•°è§£æ
  }
}
```

**åˆ¤æ–­æ ‡å‡†**ï¼š
- â“ è¿™ä¸ªä¾èµ–åªåœ¨æŸä¸ª package ä¸­ä½¿ç”¨ï¼Ÿ â†’ Package ç›®å½•
- â“ è¿™æ˜¯è¿è¡Œæ—¶å¿…éœ€çš„ä¾èµ–ï¼Ÿ â†’ Package ç›®å½•
- â“ ä¸åŒ packages å¯èƒ½éœ€è¦ä¸åŒç‰ˆæœ¬ï¼Ÿ â†’ Package ç›®å½•

### ä¸ºä»€ä¹ˆè¿™æ ·åˆ†å±‚ï¼Ÿ

1. **é¿å…ä¾èµ–æ±¡æŸ“**
   - æ¯ä¸ª package åªå®‰è£…çœŸæ­£éœ€è¦çš„ä¾èµ–
   - å‘å¸ƒ package æ—¶ä¾èµ–å…³ç³»æ¸…æ™°

2. **æ„å»ºå·¥å…·å…±äº«**
   - æ‰€æœ‰ packages ä½¿ç”¨ç›¸åŒçš„ esbuildã€eslint é…ç½®
   - ä¿è¯ä»£ç è´¨é‡å’Œæ„å»ºæ–¹å¼çš„ä¸€è‡´æ€§

3. **ç‰ˆæœ¬ç®¡ç†**
   - å¼€å‘å·¥å…·ç»Ÿä¸€ç‰ˆæœ¬ï¼ˆæ ¹ç›®å½•ï¼‰
   - è¿è¡Œæ—¶ä¾èµ–å¯ä»¥å„è‡ªç®¡ç†ç‰ˆæœ¬ï¼ˆpackage ç›®å½•ï¼‰

### Gemini-CLI çš„å®é™…æ¡ˆä¾‹

**æ ¹ç›®å½•çš„å…³é”® devDependencies**ï¼š
```json
{
  "devDependencies": {
    "esbuild": "^0.25.0",        // âœ… æ„å»ºå·¥å…·
    "vitest": "^3.2.4",          // âœ… æµ‹è¯•æ¡†æ¶
    "eslint": "^9.24.0",         // âœ… ä»£ç æ£€æŸ¥
    "prettier": "^3.5.3",        // âœ… æ ¼å¼åŒ–
    "typescript-eslint": "^8.30.1", // âœ… TS æ£€æŸ¥
    "tsx": "^4.20.3"             // âœ… TS è¿è¡Œå·¥å…·
  }
}
```

**å­ packages æ²¡æœ‰è¿™äº›å·¥å…·**ï¼š
- `packages/cli/package.json` - åªæœ‰ `ink`ã€`yargs` ç­‰ CLI ç‰¹å®šä¾èµ–
- `packages/core/package.json` - åªæœ‰ `@google/genai`ã€`zod` ç­‰æ ¸å¿ƒä¾èµ–

---

## ğŸ¯ å®è·µç»ƒä¹ ï¼šæ‰‹æŠŠæ‰‹æ„å»º esbuild æ‰“åŒ…ç³»ç»Ÿ

> **åç«¯ç±»æ¯”**: è¿™ä¸ªè¿‡ç¨‹å°±åƒåœ¨ Java/Spring Boot é¡¹ç›®ä¸­ä½¿ç”¨ Maven/Gradle é…ç½®æ„å»ºæµç¨‹ï¼Œæœ€åæ‰“åŒ…æˆå¯æ‰§è¡Œçš„ JAR æ–‡ä»¶ã€‚

---

### ğŸ“ æ•´ä½“ç›®æ ‡

å°†æˆ‘ä»¬çš„ ai-cli-project ä»å¤šä¸ªæ–‡ä»¶ç¼–è¯‘çš„çŠ¶æ€ï¼Œæ‰“åŒ…æˆ**å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶**ï¼Œå°±åƒ Java çš„ fat JAR æˆ– Go çš„å•æ–‡ä»¶å¯æ‰§è¡Œç¨‹åºã€‚

**å½“å‰çŠ¶æ€** (ä½¿ç”¨ tsc ç¼–è¯‘):
```
packages/cli/dist/
  â”œâ”€ index.js
  â”œâ”€ utils.js
  â””â”€ ... (å¤šä¸ªæ–‡ä»¶)
```

**ç›®æ ‡çŠ¶æ€** (ä½¿ç”¨ esbuild æ‰“åŒ…):
```
bundle/
  â””â”€ my-cli.js  (å•ä¸ªæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–)
```

---

## ğŸš€ Step 1: å®‰è£… esbuild

### ğŸ“ åœ¨å“ªé‡Œåš
åœ¨é¡¹ç›®**æ ¹ç›®å½•** `c:\Users\13441\Desktop\rustDemo\ai-cli-project\` ä¸‹

### ğŸ¯ ç›®çš„
å®‰è£… esbuild ä½œä¸ºå¼€å‘ä¾èµ–ã€‚esbuild æ˜¯ä¸€ä¸ªæ‰“åŒ…å·¥å…·ï¼Œå°†å¤šä¸ª JS/TS æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ã€‚

**åç«¯ç±»æ¯”**: ç±»ä¼¼äºåœ¨ Maven é¡¹ç›®ä¸­æ·»åŠ  `maven-assembly-plugin` æˆ– `maven-shade-plugin` ç”¨äºæ‰“åŒ… fat JARã€‚

### âœï¸ æ‰§è¡Œå‘½ä»¤

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd c:\Users\13441\Desktop\rustDemo\ai-cli-project

# å®‰è£… esbuild (ä½¿ç”¨å’Œ gemini-cli ç›¸åŒçš„ç‰ˆæœ¬)
npm install --save-dev esbuild@0.25.0
```

### ğŸ” éªŒè¯å®‰è£…

å®‰è£…å®Œæˆåï¼Œæ£€æŸ¥ `package.json` æ–‡ä»¶ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```json
{
  "devDependencies": {
    "esbuild": "^0.25.0"
  }
}
```

### ğŸ’¡ ä¸ºä»€ä¹ˆæ˜¯ 0.25.0ï¼Ÿ
- è¿™æ˜¯ gemini-cli ä½¿ç”¨çš„ç‰ˆæœ¬
- ä½¿ç”¨ç›¸åŒç‰ˆæœ¬å¯ä»¥é¿å…å…¼å®¹æ€§é—®é¢˜
- `^0.25.0` è¡¨ç¤ºå¯ä»¥è‡ªåŠ¨å‡çº§åˆ° 0.25.x çš„ä»»ä½•ç‰ˆæœ¬

---

## ğŸš€ Step 2: åˆ›å»ºæ„å»ºè¾“å‡ºç›®å½•

### ğŸ“ åœ¨å“ªé‡Œåš
åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `bundle` ç›®å½•

### ğŸ¯ ç›®çš„
è¿™ä¸ªç›®å½•ç”¨äºå­˜æ”¾æœ€ç»ˆæ‰“åŒ…çš„ CLI æ–‡ä»¶ï¼ŒåŒºåˆ«äº `packages/*/dist/` çš„ä¸­é—´ç¼–è¯‘äº§ç‰©ã€‚

**åç«¯ç±»æ¯”**: å°±åƒ Maven çš„ `target/` ç›®å½•æˆ– Gradle çš„ `build/` ç›®å½•ã€‚

### âœï¸ åˆ›å»ºç›®å½•ç»“æ„

```bash
# åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º
mkdir bundle
mkdir scripts
```

**ç›®å½•ç”¨é€”**:
- `bundle/` - å­˜æ”¾æœ€ç»ˆæ‰“åŒ…çš„å¯æ‰§è¡Œæ–‡ä»¶
- `scripts/` - å­˜æ”¾æ„å»ºè„šæœ¬ï¼ˆç±»ä¼¼ Maven çš„ build scriptsï¼‰

---

## ğŸš€ Step 3: åˆ›å»º esbuild é…ç½®æ–‡ä»¶

### ğŸ“ åœ¨å“ªé‡Œåš
åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `esbuild.config.js`

### ğŸ¯ ç›®çš„
é…ç½® esbuild å¦‚ä½•æ‰“åŒ…æˆ‘ä»¬çš„ä»£ç ï¼Œç±»ä¼¼äº Maven çš„ `pom.xml` æˆ– Gradle çš„ `build.gradle`ã€‚

### âœï¸ åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶è·¯å¾„**: `c:\Users\13441\Desktop\rustDemo\ai-cli-project\esbuild.config.js`

```javascript
/**
 * esbuild æ„å»ºé…ç½®
 * 
 * ç›®çš„: å°† packages/cli æ‰“åŒ…æˆå•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
 * ç±»æ¯”: Java Maven çš„ assembly é…ç½®ï¼Œç”¨äºæ‰“åŒ… fat JAR
 */

import esbuild from 'esbuild';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { createRequire } from 'node:module';

// è·å–å½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½• (å› ä¸º ES Module æ²¡æœ‰ __dirname)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const require = createRequire(import.meta.url);

// è¯»å–æ ¹ç›®å½•çš„ package.json è·å–ç‰ˆæœ¬å·
const pkg = require(path.resolve(__dirname, 'package.json'));

/**
 * åŸºç¡€é…ç½®
 * è¿™äº›é…ç½®ä¼šåº”ç”¨åˆ°æ‰€æœ‰æ„å»ºä»»åŠ¡
 */
const baseConfig = {
  bundle: true,        // æ‰“åŒ…æ‰€æœ‰ä¾èµ– (ç±»ä¼¼ Maven fat JAR)
  platform: 'node',    // ç›®æ ‡å¹³å°æ˜¯ Node.js (ä¸æ˜¯æµè§ˆå™¨)
  format: 'esm',       // è¾“å‡º ES Module æ ¼å¼ (ä½¿ç”¨ import/export)
  loader: {
    '.node': 'file'    // .node æ–‡ä»¶æ˜¯åŸç”Ÿæ¨¡å—ï¼Œä½œä¸ºæ–‡ä»¶å¤„ç†
  },
  write: true,         // ç›´æ¥å†™å…¥æ–‡ä»¶ç³»ç»Ÿ
};

/**
 * CLI åº”ç”¨é…ç½®
 * æ‰“åŒ… packages/cli æˆä¸ºå¯æ‰§è¡Œæ–‡ä»¶
 */
const cliConfig = {
  ...baseConfig,
  
  // ğŸ“Œ å…¥å£æ–‡ä»¶: ä»å“ªé‡Œå¼€å§‹æ‰“åŒ…
  entryPoints: ['packages/cli/src/index.ts'],
  
  // ğŸ“Œ è¾“å‡ºæ–‡ä»¶: æ‰“åŒ…åçš„æ–‡ä»¶æ”¾åœ¨å“ªé‡Œ
  outfile: 'bundle/my-cli.js',
  
  // ğŸ“Œ Banner: åœ¨ç”Ÿæˆçš„æ–‡ä»¶å¼€å¤´æ³¨å…¥çš„ä»£ç 
  // ç›®çš„: å› ä¸º ESM æ²¡æœ‰ requireã€__filenameã€__dirname
  // è¿™é‡Œæ‰‹åŠ¨åˆ›å»ºè¿™äº›å˜é‡ä»¥å…¼å®¹æŸäº›è€ä»£ç 
  banner: {
    js: `
// å…¼å®¹æ€§ä»£ç : æä¾› CommonJS çš„ require, __filename, __dirname
import { createRequire } from 'module';
const require = createRequire(import.meta.url);
globalThis.__filename = require('url').fileURLToPath(import.meta.url);
globalThis.__dirname = require('path').dirname(globalThis.__filename);
    `.trim()
  },
  
  // ğŸ“Œ Define: å®šä¹‰ç¼–è¯‘æ—¶å¸¸é‡
  // ç±»ä¼¼äº Java çš„ç¼–è¯‘æ—¶å¸¸é‡æ›¿æ¢
  define: {
    'process.env.CLI_VERSION': JSON.stringify(pkg.version)
  },
  
  // ğŸ“Œ External: ä¸æ‰“åŒ…çš„ä¾èµ–ï¼Œè¿è¡Œæ—¶ä» node_modules åŠ è½½
  // ä¸ºä»€ä¹ˆ? æŸäº›åŸç”Ÿæ¨¡å—(åŒ…å« .node æ–‡ä»¶)ä¸èƒ½æ‰“åŒ…
  external: [
    // æš‚æ—¶æ²¡æœ‰ï¼Œåç»­å¦‚æœç”¨åˆ°åŸç”Ÿæ¨¡å—å†æ·»åŠ 
  ],
};

// æ‰§è¡Œæ„å»º
console.log('ğŸ”¨ å¼€å§‹æ„å»º CLI åº”ç”¨...');
console.log(`ğŸ“¦ å…¥å£: ${cliConfig.entryPoints[0]}`);
console.log(`ğŸ“‚ è¾“å‡º: ${cliConfig.outfile}`);
console.log(`ğŸ·ï¸  ç‰ˆæœ¬: ${pkg.version}`);

esbuild.build(cliConfig)
  .then(() => {
    console.log('âœ… æ„å»ºæˆåŠŸ!');
    console.log(`ğŸ“ ç”Ÿæˆæ–‡ä»¶: ${cliConfig.outfile}`);
  })
  .catch((error) => {
    console.error('âŒ æ„å»ºå¤±è´¥:', error);
    process.exit(1);
  });
```

### ğŸ”‘ é…ç½®é¡¹è¯¦è§£

| é…ç½®é¡¹ | ä½œç”¨ | åç«¯ç±»æ¯” |
|--------|------|----------|
| `bundle: true` | å°†æ‰€æœ‰ import çš„æ¨¡å—æ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶ | Maven çš„ shade plugin |
| `platform: 'node'` | ç›®æ ‡æ˜¯ Node.js ç¯å¢ƒï¼Œä¸æ˜¯æµè§ˆå™¨ | æŒ‡å®šè¿è¡Œç¯å¢ƒ(JVM/Node) |
| `format: 'esm'` | è¾“å‡º ES Module æ ¼å¼ | ç±»ä¼¼é€‰æ‹©è¾“å‡ºæ ¼å¼ |
| `entryPoints` | ä»å“ªä¸ªæ–‡ä»¶å¼€å§‹æ‰“åŒ… | Maven çš„ä¸»ç±»(Main-Class) |
| `outfile` | æ‰“åŒ…åçš„è¾“å‡ºæ–‡ä»¶ | æœ€ç»ˆçš„ JAR æ–‡ä»¶è·¯å¾„ |
| `banner` | åœ¨æ–‡ä»¶å¼€å¤´æ³¨å…¥ä»£ç  | ç±»ä¼¼ manifest headers |
| `define` | ç¼–è¯‘æ—¶æ›¿æ¢å¸¸é‡ | Maven çš„ resource filtering |
| `external` | ä¸æ‰“åŒ…çš„ä¾èµ– | Maven çš„ provided scope |

---

## ğŸš€ Step 4: åˆ›å»ºä¸»æ„å»ºè„šæœ¬

### ğŸ“ åœ¨å“ªé‡Œåš
åœ¨ `scripts/` ç›®å½•ä¸‹åˆ›å»º `build.js`

### ğŸ¯ ç›®çš„
åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„æ„å»ºæµç¨‹ï¼Œå…ˆç¼–è¯‘å„ä¸ª packageï¼Œå†æ‰“åŒ…æœ€ç»ˆåº”ç”¨ã€‚

**åç«¯ç±»æ¯”**: ç±»ä¼¼äºç¼–å†™ä¸€ä¸ª shell è„šæœ¬ï¼Œå…ˆ `mvn compile`ï¼Œå† `mvn package`ã€‚

### âœï¸ åˆ›å»ºè„šæœ¬æ–‡ä»¶

**æ–‡ä»¶è·¯å¾„**: `c:\Users\13441\Desktop\rustDemo\ai-cli-project\scripts\build.js`

```javascript
/**
 * ä¸»æ„å»ºè„šæœ¬
 * 
 * æ„å»ºæµç¨‹:
 * 1. æ£€æŸ¥å¹¶å®‰è£…ä¾èµ– (npm install)
 * 2. ç¼–è¯‘å„ä¸ª package (tsc)
 * 3. æ‰“åŒ…æœ€ç»ˆçš„ CLI åº”ç”¨ (esbuild)
 * 
 * åç«¯ç±»æ¯”: ç›¸å½“äº Maven çš„ 'mvn clean install' å®Œæ•´æµç¨‹
 */

import { execSync } from 'node:child_process';
import { existsSync } from 'node:fs';
import { dirname, join } from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const root = join(__dirname, '..');

console.log('ğŸš€ å¼€å§‹å®Œæ•´æ„å»ºæµç¨‹...\n');

// Step 1: æ£€æŸ¥ä¾èµ–
console.log('ğŸ“¦ Step 1: æ£€æŸ¥ä¾èµ–');
if (!existsSync(join(root, 'node_modules'))) {
  console.log('   æœªå‘ç° node_modulesï¼Œæ­£åœ¨å®‰è£…ä¾èµ–...');
  execSync('npm install', { stdio: 'inherit', cwd: root });
} else {
  console.log('   âœ… ä¾èµ–å·²å®‰è£…\n');
}

// Step 2: ç¼–è¯‘æ‰€æœ‰ packages (ä½¿ç”¨ TypeScript)
console.log('ğŸ”§ Step 2: ç¼–è¯‘æ‰€æœ‰ packages (tsc)');
console.log('   è¿™ä¼šç”Ÿæˆ packages/*/dist/ ç›®å½•');
execSync('npm run build --workspaces', { stdio: 'inherit', cwd: root });
console.log('   âœ… æ‰€æœ‰ packages ç¼–è¯‘å®Œæˆ\n');

// Step 3: æ‰“åŒ… CLI åº”ç”¨ (ä½¿ç”¨ esbuild)
console.log('ğŸ“¦ Step 3: æ‰“åŒ… CLI åº”ç”¨ (esbuild)');
console.log('   è¿™ä¼šç”Ÿæˆ bundle/my-cli.js æ–‡ä»¶');
execSync('node esbuild.config.js', { stdio: 'inherit', cwd: root });
console.log('   âœ… CLI åº”ç”¨æ‰“åŒ…å®Œæˆ\n');

console.log('ğŸ‰ æ„å»ºå®Œæˆï¼');
console.log('ğŸ’¡ è¿è¡Œ "node bundle/my-cli.js" æ¥æµ‹è¯•');
```

### ğŸ“– è„šæœ¬æ‰§è¡Œæµç¨‹

```
æ„å»ºæµç¨‹è§£æï¼ˆåç«¯è§†è§’ï¼‰:

1. npm install        â†’ ç±»ä¼¼ mvn dependency:resolve
   â””â”€ å®‰è£…æ‰€æœ‰ä¾èµ–

2. npm run build --workspaces  â†’ ç±»ä¼¼ mvn compile (å¤šæ¨¡å—)
   â””â”€ ç¼–è¯‘ packages/core     (tsc)
   â””â”€ ç¼–è¯‘ packages/cli      (tsc)
   â””â”€ ç”Ÿæˆ .d.ts ç±»å‹æ–‡ä»¶

3. node esbuild.config.js     â†’ ç±»ä¼¼ mvn assembly:single
   â””â”€ æ‰“åŒ…æˆå•æ–‡ä»¶
   â””â”€ è¾“å‡ºåˆ° bundle/
```

---

## ğŸš€ Step 5: ä¿®æ”¹ package.json æ·»åŠ æ„å»ºå‘½ä»¤

### ğŸ“ åœ¨å“ªé‡Œåš
ä¿®æ”¹æ ¹ç›®å½•çš„ `package.json`

### ğŸ¯ ç›®çš„
æ·»åŠ æ–¹ä¾¿çš„ npm è„šæœ¬å‘½ä»¤ï¼Œç±»ä¼¼äº Maven çš„ `mvn clean install`ã€‚

### âœï¸ ä¿®æ”¹æ–‡ä»¶

æ‰“å¼€ `c:\Users\13441\Desktop\rustDemo\ai-cli-project\package.json`ï¼Œä¿®æ”¹ `scripts` éƒ¨åˆ†ï¼š

```json
{
  "scripts": {
    "build": "npm run build --workspaces --if-present",  
    "build:all": "node scripts/build.js",
    "bundle": "node esbuild.config.js",
    "test": "npm run test --workspaces --if-present",
    "dev": "npm run dev --workspaces --if-present"
  }
}
```

### ğŸ”‘ å‘½ä»¤è¯´æ˜

| å‘½ä»¤ | ä½œç”¨ | åç«¯ç±»æ¯” |
|------|------|----------|
| `npm run build` | åªç¼–è¯‘å„ packages (tsc) | `mvn compile` |
| `npm run build:all` | å®Œæ•´æ„å»ºæµç¨‹ | `mvn clean install` |
| `npm run bundle` | åªæ‰“åŒ… CLI | `mvn assembly:single` |

---

## ğŸš€ Step 6: æµ‹è¯•æ„å»º

### ğŸ“ åœ¨å“ªé‡Œåš
åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ

### ğŸ¯ ç›®çš„
éªŒè¯æ„å»ºç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ

### âœï¸ æ‰§è¡Œæ„å»º

```bash
# æ–¹å¼1: å®Œæ•´æ„å»ºï¼ˆæ¨èç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰
npm run build:all

# æ–¹å¼2: åˆ†æ­¥éª¤æ„å»º
npm run build    # å…ˆç¼–è¯‘
npm run bundle   # å†æ‰“åŒ…
```

### ğŸ” é¢„æœŸç»“æœ

æ„å»ºæˆåŠŸåï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```
ai-cli-project/
  â”œâ”€ packages/
  â”‚   â”œâ”€ core/dist/        â† tsc ç¼–è¯‘çš„ core åŒ…
  â”‚   â”‚   â”œâ”€ index.js
  â”‚   â”‚   â””â”€ index.d.ts
  â”‚   â””â”€ cli/dist/         â† tsc ç¼–è¯‘çš„ cli åŒ…
  â”‚       â”œâ”€ index.js
  â”‚       â””â”€ index.d.ts
  â””â”€ bundle/
      â””â”€ my-cli.js         â† esbuild æ‰“åŒ…çš„å•æ–‡ä»¶ âœ¨
```

### âœ… æµ‹è¯•è¿è¡Œ

```bash
# è¿è¡Œæ‰“åŒ…åçš„ CLI
node bundle/my-cli.js

# åº”è¯¥çœ‹åˆ°è¾“å‡º: "Hello from AI CLI!"
```

---

## ğŸ“Š ç»ƒä¹ 2: å¯¹æ¯” tsc å’Œ esbuild è¾“å‡º

### ğŸ¯ ç›®çš„
ç†è§£ tsc ç¼–è¯‘å’Œ esbuild æ‰“åŒ…çš„åŒºåˆ«

### ğŸ” å¯¹æ¯”åˆ†æ

#### 1. æ–‡ä»¶æ•°é‡å¯¹æ¯”

```bash
# æŸ¥çœ‹ tsc ç¼–è¯‘è¾“å‡ºï¼ˆpackages/cli/distï¼‰
ls packages/cli/dist/
# ç»“æœ: index.js, index.d.ts (ä¿ç•™åŸå§‹ç»“æ„)

# æŸ¥çœ‹ esbuild æ‰“åŒ…è¾“å‡º (bundle/)
ls bundle/
# ç»“æœ: my-cli.js (å•ä¸ªæ–‡ä»¶)
```

#### 2. æ–‡ä»¶å¤§å°å¯¹æ¯”

```bash
# Windows PowerShell
Get-ChildItem -Recurse packages/cli/dist/ | Measure-Object -Property Length -Sum
Get-ChildItem bundle/my-cli.js | Measure-Object -Property Length -Sum
```

#### 3. å¯åŠ¨é€Ÿåº¦å¯¹æ¯”

```bash
# æµ‹è¯• tsc ç¼–è¯‘ç‰ˆæœ¬
Measure-Command { node packages/cli/dist/index.js }

# æµ‹è¯• esbuild æ‰“åŒ…ç‰ˆæœ¬  
Measure-Command { node bundle/my-cli.js }
```

### ğŸ“ è§‚å¯Ÿè¦ç‚¹

| å¯¹æ¯”é¡¹ | tsc ç¼–è¯‘ | esbuild æ‰“åŒ… |
|--------|----------|--------------|
| **æ–‡ä»¶æ•°é‡** | å¤šä¸ªæ–‡ä»¶ | å•ä¸ªæ–‡ä»¶ |
| **æ–‡ä»¶ç»“æ„** | ä¿ç•™åŸå§‹ç»“æ„ | æ‰€æœ‰ä»£ç åˆå¹¶ |
| **ç±»å‹å®šä¹‰** | ç”Ÿæˆ .d.ts | ä¸ç”Ÿæˆ |
| **é€‚ç”¨åœºæ™¯** | å‘å¸ƒ npm åº“ | å‘å¸ƒå¯æ‰§è¡Œç¨‹åº |
| **å¯åŠ¨é€Ÿåº¦** | æ…¢(åŠ è½½å¤šä¸ªæ–‡ä»¶) | å¿«(å•æ–‡ä»¶) |
| **ä¾èµ–å¤„ç†** | éœ€è¦ node_modules | å¤§éƒ¨åˆ†å·²å†…ç½® |

**åç«¯ç±»æ¯”**:
- **tsc ç¼–è¯‘** = ç¼–è¯‘ Java æºç æˆ .class æ–‡ä»¶ï¼ˆä¿ç•™ç»“æ„ï¼‰
- **esbuildæ‰“åŒ…** = æ‰“åŒ…æˆ uber/fat JARï¼ˆæ‰€æœ‰ä¾èµ–å†…ç½®ï¼‰

---

## ğŸ”‘ å…³é”®æ¦‚å¿µæ€»ç»“

### 1. ä¸ºä»€ä¹ˆéœ€è¦æ‰“åŒ…ï¼Ÿ

**æœªæ‰“åŒ…çš„é—®é¢˜**:
```
my-cli/
  â”œâ”€ dist/
  â”‚   â”œâ”€ index.js
  â”‚   â”œâ”€ utils.js
  â”‚   â”œâ”€ commands/
  â”‚   â”‚   â”œâ”€ chat.js
  â”‚   â”‚   â””â”€ help.js
  â”‚   â””â”€ ... (å¾ˆå¤šæ–‡ä»¶)
```
- å¯åŠ¨æ…¢(éœ€è¦åŠ è½½å¾ˆå¤šæ–‡ä»¶)
- åˆ†å‘éº»çƒ¦(éœ€è¦å¤åˆ¶æ•´ä¸ªç›®å½•)
- ä¾èµ–å¤æ‚(éœ€è¦ node_modules)

**æ‰“åŒ…å**:
```
bundle/
  â””â”€ gemini.js  (å•ä¸ªæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ä»£ç )
```
- å¯åŠ¨å¿«(åªåŠ è½½ä¸€ä¸ªæ–‡ä»¶)
- åˆ†å‘ç®€å•(ä¸€ä¸ªæ–‡ä»¶å³å¯)
- ä¾èµ–å†…ç½®(å¤§éƒ¨åˆ†ä¾èµ–å·²æ‰“åŒ…)

### 2. external (å¤–éƒ¨ä¾èµ–)

æŸäº›ä¾èµ–ä¸èƒ½æˆ–ä¸åº”è¯¥æ‰“åŒ…ï¼š

```javascript
external: [
  '@lydell/node-pty',  // åŸç”Ÿæ¨¡å—(åŒ…å« .node æ–‡ä»¶)
  'node-pty',
  // ...
]
```

**ä¸ºä»€ä¹ˆä¸æ‰“åŒ…**:
- **åŸç”Ÿæ¨¡å—**: åŒ…å«ç¼–è¯‘çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå¹³å°ç›¸å…³
- **å¯é€‰ä¾èµ–**: ä¸æ˜¯æ‰€æœ‰ç¯å¢ƒéƒ½éœ€è¦
- **ä½“ç§¯å·¨å¤§**: æŸäº›åº“å¤ªå¤§ï¼Œå¤–éƒ¨åŠ è½½æ›´å¥½

### 3. banner (å¤´éƒ¨æ³¨å…¥ä»£ç )

```javascript
banner: {
  js: `import { createRequire } from 'module'; 
       const require = createRequire(import.meta.url); 
       globalThis.__filename = require('url').fileURLToPath(import.meta.url); 
       globalThis.__dirname = require('path').dirname(globalThis.__filename);`
}
```

**ä½œç”¨**: 
- åœ¨ ESM æ¨¡å—ä¸­æä¾› `require`ã€`__filename`ã€`__dirname`
- å› ä¸º ESM åŸç”Ÿä¸æ”¯æŒè¿™äº› CommonJS å˜é‡
- ä½†å¾ˆå¤šåº“å’Œä»£ç ä¾ç„¶ä½¿ç”¨å®ƒä»¬

### 4. define (å®šä¹‰å¸¸é‡)

```javascript
define: {
  'process.env.CLI_VERSION': JSON.stringify('1.0.0')
}
```

**ä½œç”¨**: åœ¨ç¼–è¯‘æ—¶æ›¿æ¢ä»£ç ä¸­çš„ç‰¹å®šå­—ç¬¦ä¸²

```javascript
// æºä»£ç 
console.log(process.env.CLI_VERSION);

// ç¼–è¯‘å
console.log("1.0.0");
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ„å»ºåˆ†å±‚

```
åº“(packages/*)    â†’ tsc ç¼–è¯‘    â†’ dist/  (ä¿ç•™ç±»å‹ï¼Œæ¨¡å—åŒ–)
åº”ç”¨(CLI)        â†’ esbuildæ‰“åŒ…  â†’ bundle/ (å•æ–‡ä»¶ï¼Œä¼˜åŒ–)
```

### 2. å¼€å‘ vs ç”Ÿäº§

**å¼€å‘é˜¶æ®µ**:
```json
{
  "scripts": {
    "dev": "tsc --watch",  // ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œå¢é‡ç¼–è¯‘
    "start": "node dist/index.js"
  }
}
```

**ç”Ÿäº§æ„å»º**:
```json
{
  "scripts": {
    "build": "npm run build:packages && npm run build:bundle",
    "build:packages": "npm run build --workspaces",
    "build:bundle": "node esbuild.config.js"
  }
}
```

### 3. ä»€ä¹ˆæ—¶å€™ç”¨ esbuildï¼Ÿ

- âœ… æ„å»ºå¯æ‰§è¡Œçš„ CLI å·¥å…·
- âœ… æ„å»º Web åº”ç”¨
- âœ… å¿«é€ŸåŸå‹å¼€å‘
- âŒ å‘å¸ƒ npm åº“(åº”è¯¥ç”¨ tsc ä¿ç•™ç±»å‹å®šä¹‰)

---

## ğŸ“ ç»ƒä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ esbuild çš„ä½œç”¨å’Œä¼˜åŠ¿
- [ ] ç†è§£ tsc å’Œ esbuild çš„åŒºåˆ«å’Œé€‚ç”¨åœºæ™¯
- [ ] æˆåŠŸé…ç½® esbuild.config.js
- [ ] ç†è§£ bundleã€externalã€bannerã€define ç­‰é…ç½®
- [ ] æˆåŠŸæ„å»ºå‡ºå•æ–‡ä»¶çš„ CLI åº”ç”¨
- [ ] å¯¹æ¯”æ„å»ºå‰åçš„æ–‡ä»¶ç»“æ„å’Œå¤§å°
- [ ] æµ‹è¯•æ‰“åŒ…åçš„ CLI æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œ

---

## ğŸ”— å‚è€ƒèµ„æº

- [esbuild å®˜æ–¹æ–‡æ¡£](https://esbuild.github.io/)
- [esbuild API æ–‡æ¡£](https://esbuild.github.io/api/)
- [Node.js ES Modules](https://nodejs.org/api/esm.html)
